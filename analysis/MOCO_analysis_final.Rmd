---
title: "MOCO_analysis_final"
author: "yiming"
date: "May 29, 2020"
output: html_document
---

# set up the environment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(knitr)
library(psyphy)
library(sjPlot)
library(dplyr)
library(viridis)
library(ggplot2)
# if (!("pacman" %in% installed.packages()[,])) {
#     install.packages("pacman")
#   }
# library(pacman)
# pacman::p_load(dplyr, ggplot2, knitr, psyphy, lme4, sjPlot)
```


# Import aggregate data

Here we import the aggregate data file found in `analysis/data/child/data-aggregate/moco-beh-child.csv`, convert `Age`(continuous) to a categorical factor, `AgeYrs` (ordinal). Gender is a factor into 1 (female) and 2 (male). In this dataset, the NaN of Acc is fixed but the outliers are not cleaned up.

Here we import the aggregate adult data file found in `analysis/data/moco-adult.csv`. we also summarize the mean percent correct in adults to chech whether each participant have the the mean accuracy higher than 50% (guess rate).

```{r load-files}
df_child <- read.csv(file = "~/R/moco-psychophysics/analysis/data/child/data-aggregate/moco-beh-child.csv", header = TRUE)
df_adult <- read.csv(file = "~/R/moco-psychophysics/analysis/data/moco-adult.csv", header = TRUE)
df_adult$Speed <- factor(df_adult$Speed, labels = c("2 deg/s", "8 deg/s"))
df_child$Speed <- factor(df_child$Speed, labels = c("2 deg/s", "8 deg/s"))
df_child$SubID <- factor(df_child$SubID)
df_adult$SubID <- factor(df_adult$SubID)
df_child$Age <- df_child$AgeDays/365.25
df_child$AgeYrs <- ordered(cut(df_child$AgeDays/365.25, 
                 breaks = c(5,6,7,8,9), 
                 labels = c("5-year-old", "6-year-old", "7-year-old", "8-year-old")))
df_adult %>% 
  group_by( SubID) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr = N.corr/N.tot) -> 
  df_adult.summary
# df_child <- df_child %>%
#   dplyr::select(SubID, PatternType, RT, Acc, Speed, Gender, Coh, Age, AgeYrs, Response)
#df_adult <- df_adult %>%
#   dplyr::select(SubID, PatternType, RT, Acc, Speed, Gender, Coh, Age, Response)
```

# child GLMM
In this model, we perform GLMM in child datasets to examine the effects of age, sex, coherence, speed and pattern type on accuracy responses. The DV is the binary response, either right or wrong. The main IVs are age (continuous), sex (factor:2), coherence (factor:4), speed (factor:2), pattern type (factor:2). We want to have the most parsimous model with the IV which are interpretable. The following is the procedures that we find the model with the best model fits.

(1) all IVs and their interactions
(2) three main experimental conditions (speed, coherence, pattern) and their interactions
(3) check the model with the significant effects
(4) add age and sex
(5) add sex-related and age-related interactions
(6) check the model with the significant effects
(7) compare three link function (weibull, logit, probit)

### check the GLMM with logit links functions with all IVs and their interactions
```{r acc-logit-full-child, eval=FALSE}
form.fullmodel<- Acc ~ scale(Coh)*Speed*PatternType*scale(Age)*Gender + (1|SubID)
model.acc.logit.full_c <- glmer(formula = form.fullmodel, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
summary(model.acc.logit.full_c)
```

### check the GLMM with three experimental conditions and their interactions
```{r acc-logit-full-child, eval=FALSE}
form.explor<- Acc ~ scale(Coh)*Speed*PatternType + (1|SubID)
model.acc.logit.ex_c <- glmer(formula = form.explor, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
summary(model.acc.logit.ex_c)
```

### check the models with three experimental conditions and their significant interactions
```{r acc-logit-full-child, eval=FALSE}
form.explor1<- Acc ~ scale(Coh)+Speed+PatternType+scale(Coh)*Speed + (1|SubID)
model.acc.logit.ex1_c <- glmer(formula = form.explor1, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
summary(model.acc.logit.ex1_c)
anova(model.acc.logit.ex1_c, model.acc.logit.ex_c)
```

### Add age and sex 
```{r acc-logit-full-child, eval=FALSE}
form.explor2<- Acc ~ scale(Coh)+Speed+PatternType+Gender+scale(Age)+scale(Coh)*Speed + (1|SubID)
model.acc.logit.ex2_c <- glmer(formula = form.explor2, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
summary(model.acc.logit.ex2_c)
anova(model.acc.logit.ex1_c, model.acc.logit.ex2_c)
```

### Add age-related and sex-related interactions 
```{r acc-logit-full-child, eval=FALSE}
form_c.explor3<- Acc ~ scale(Coh)+Speed+PatternType+Gender+scale(Age)+scale(Coh)*Speed+ Speed*scale(Age)+PatternType*scale(Age)+Speed*Gender+PatternType*Gender+ (1|SubID)
model.acc.logit.ex3_c <- glmer(formula = form_c.explor3, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
summary(model.acc.logit.ex3_c)
car::Anova(model.acc.logit.ex3_c, model.acc.logit.ex2_c)
```

### check the models with significant variables
```{r acc-logit-full-child, eval=FALSE}
form_c.explor4<- Acc ~ scale(Coh)+Speed+PatternType+Gender+scale(Age)+scale(Coh)*Speed+ Speed*scale(Age)+ (1|SubID)
model.acc.logit_c <- glmer(formula = form_c.explor4, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
summary(model.acc.logit_c)
car::Anova(model.acc.logit_c, model.acc.logit.ex3_c)
```
### check probit& weibull link function
```{r acc-probit-full, eval=FALSE}
model.acc.probit_c<- glmer(formula = form_c.explor3, family=binomial(mafc.probit(2)),glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
model.acc.weibull_c<- glmer(formula = form_c.explor3, family=binomial(mafc.cloglog(2)),glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
car::Anova(model.acc.probit_c, model.acc.logit_c )
car::Anova(model.acc.weibull_c, model.acc.logit_c )
```
The logit link function has the best model fit.

### further examine the final model
we calculated the chi-square, 95% CI, conditional R square, marginal R square.
```{r test-child}
car::Anova(model.acc.logit_c, type=3)
# for binomial response data
#compute the marginal R-square
#compute the variance in the fitted values
VarF <- var(as.vector(fixef(model.acc.logit_c) %*% t(model.acc.logit_c@pp$X)))
# VarCorr() extracts variance components
# attr(VarCorr(lmer.model),’sc’)^2 extracts the residual variance, VarCorr()$plot extract the variance of the plot effect
VarF/(VarF + VarCorr(model.acc.logit_c)[[1]][1] + attr(VarCorr(model.acc.logit_c), 'sc')^2 + (pi^2)/3)

#compute the conditionnal R-square
(VarF + VarCorr(model.acc.logit_c)[[1]][1])/(VarF + VarCorr(model.acc.logit_c)[[1]][1] + (attr(VarCorr(model.acc.logit_c), 'sc')^2) + (pi^2)/3)
# The residual deviance in logistic regression is fixed to (pi ^ 2) / 3

# get 95% CI
se <- sqrt(diag(vcov(model.acc.logit_c)))
# table of estimates with 95% CI
tab <- cbind(OR = fixef(model.acc.logit_c), LL = fixef(model.acc.logit_c) - 1.96 * se, UL = fixef(model.acc.logit_c) + 1.96 * se)
# however, this result is different from the below
print(exp(tab))
```


# adult GLMM
In this model, we perform GLMM in adult datasets to examine the effects of sex, coherence, speed and pattern type on accuracy responses. The DV is the binary response, either right or wrong. The main IVs are sex (factor:2), coherence (factor:4), speed (factor:2), pattern type (factor:2). We want to have the most parsimous model with the IV which are interpretable. The procedures to find the model with the best model fits is very similar to those to find the best child datasets.

(1) all IVs and their interactions
(2) three main experimental conditions (speed, coherence, pattern) and their interactions
(3) check the model with the significant effects
(4) add sex
(5) add sex-related interactions
(6) check the model with the significant effects
(7) compare three link function (weibull, logit, probit)

### check the GLMM with logit links functions with all IVs and their interactions
```{r acc-logit-full-adult, eval=FALSE}
form.fullmodel<- Acc ~ scale(Coh)*Speed*PatternType*scale(Age)*Gender + (1|SubID)
model.acc.logit.full_a <- glmer(formula = form.fullmodel, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_child)
summary(model.acc.logit.full_a)
```

### check the models with three experimental conditions and their interactions
```{r acc-logit-full-adult, eval=FALSE}
form.explor<- Acc ~ scale(Coh)*Speed*PatternType + (1|SubID)
model.acc.logit.ex_a <- glmer(formula = form.explor, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_adult)
summary(model.acc.logit.ex_a)
```

### check the models with significant effects found in the last model
```{r acc-logit-full-adult, eval=FALSE}
form.explor1<- Acc ~ scale(Coh)+Speed+PatternType+scale(Coh)*PatternType + (1|SubID)
model.acc.logit.ex1_a <- glmer(formula = form.explor1, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_adult)
summary(model.acc.logit.ex1_a)
anova(model.acc.logit.ex1_a, model.acc.logit.ex_a)
```

### Add gender
```{r acc-logit-full-adult, eval=FALSE}
form.explor2<- Acc ~ scale(Coh)+Speed+PatternType+scale(Coh)*PatternType + Gender+ (1|SubID)
model.acc.logit.ex2_a <- glmer(formula = form.explor2, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_adult)
summary(model.acc.logit.ex2_a)
anova(model.acc.logit.ex1_a, model.acc.logit.ex2_a)
```

### Add sex-related interactions
```{r}
form_a.explor3<- Acc ~ scale(Coh)+Speed+PatternType+scale(Coh)*PatternType + Gender + Gender*Speed +Gender*PatternType+ (1|SubID)
model.acc.logit_a <- glmer(formula = form_a.explor3, family=binomial(mafc.logit(2)), glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_adult)
summary(model.acc.logit_a)
anova(model.acc.logit.ex2_a, model.acc.logit_a)
```

### probit& weibull link function
```{r acc-probit-full, eval=FALSE}
model.acc.probit_a<- glmer(formula = form_a.explor3, family=binomial(mafc.probit(2)),glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_adult)
model.acc.weibull_a<- glmer(formula = form_a.explor3, family=binomial(mafc.cloglog(2)),glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)), data = df_adult)
anova(model.acc.logit_a, model.acc.probit_a, model.acc.weibull_a)
```

The logit link function has the best model fit

### further examine the final model
we calculated the chi-square, 95% CI, conditional R square, marginal R square.
```{r test-adult}
car::Anova(model.acc.logit_a, type=3)
# for binomial response data
#compute the marginal R-square
#compute the variance in the fitted values
VarF <- var(as.vector(fixef(model.acc.logit_a) %*% t(model.acc.logit_a@pp$X)))
# VarCorr() extracts variance components
# attr(VarCorr(lmer.model),’sc’)^2 extracts the residual variance, VarCorr()$plot extract the variance of the plot effect
VarF/(VarF + VarCorr(model.acc.logit_a)[[1]][1] + attr(VarCorr(model.acc.logit_a), 'sc')^2 + (pi^2)/3)

#compute the conditionnal R-square
(VarF + VarCorr(model.acc.logit_a)[[1]][1])/(VarF + VarCorr(model.acc.logit_a)[[1]][1] + (attr(VarCorr(model.acc.logit_a), 'sc')^2) + (pi^2)/3)
# The residual deviance in logistic regression is fixed to (pi ^ 2) / 3

# get 95% CI
se <- sqrt(diag(vcov(model.acc.logit_a)))
# table of estimates with 95% CI
tab <- cbind(OR = fixef(model.acc.logit_a), LL = fixef(model.acc.logit_a) - 1.96 * se, UL = fixef(model.acc.logit_a) + 1.96 * se)
# however, this result is different from the below
print(exp(tab))
```

### Post-hoc comparison of the interaction effects
```{r post-hoc}
lsmeans::lsmeans(model.acc.logit_a, pairwise~Gender:Speed, adjust="tukey")
lsmeans::lsmeans(model.acc.logit_a, pairwise~Gender:PatternType, adjust="tukey")
```





# plot 

### make the theme for all figures
```{r ggplot-themes}
# "The APA has determined specifications for the size of figures and the fonts used in them. Figures of one column must be between 2 and 3.25 inches wide (5 to 8.45 cm). Two-column figures must be between 4.25 and 6.875 inches wide (10.6 to 17.5 cm). The height of figures should not exceed the top and bottom margins. The text in a figure should be in a san serif font (such as Helvetica, Arial, or Futura). The font size must be between eight and fourteen point. Use circles and squares to distinguish curves on a line graph (at the same font size as the other labels). "
theme.custom <- theme(panel.background = element_rect(fill = "white", colour = "grey50"),
                      plot.title = element_text(size=18, face="bold",hjust = 0.5),
                      axis.title.x = element_text(size=18),
                      axis.title.y = element_text(size=18),
                      strip.text = element_text(size=18),
                      axis.text = element_text(size=18),
                      legend.position = c(0.85,0.14),
                      legend.title=element_text(size=18),
#  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   #   legend.title=element_blank(),
                      legend.text=element_text(size=18))
```

# child figure
### the figure of the mean accuracy by pattern and coherence
```{r}
# df_child$Coh<-factor(df_child$Coh)
df_p2_c_acc_pat_coh <- df_child %>% 
  filter(Group=="linear-radial coh [.15 .3 .45 .6]") %>%
  group_by(SubID, PatternType, Coh) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr = N.corr/N.tot)  %>% 
  group_by(PatternType, Coh) %>%
  mutate(n=length(Pct.Corr),
            Pct.Corr.mean = 100*mean(Pct.Corr, na.rm=TRUE),
            Pct.Corr.ci = 1.96*100*sd(Pct.Corr, na.rm=TRUE)/sqrt(length(Pct.Corr)))  #computation of the standard error of the mean, ci is 1.96*sem
df_p2_c_acc_pat_coh$Coh<-factor(df_p2_c_acc_pat_coh$Coh, levels=c("0.15","0.3","0.45","0.6"), labels=c("15%","30%","45%","60%"))
df_p2_c_acc_pat_coh$Pattern<-factor(df_p2_c_acc_pat_coh$PatternType, levels=c("linear","radial"), labels=c("Linear","Radial"))
p0<-ggplot(df_p2_c_acc_pat_coh, aes(x = Coh, y = Pct.Corr*100, color = PatternType, shape=PatternType),  alpha = 0.5) +
  geom_point(data = df_p2_c_acc_pat_coh, aes(x = Coh, y = Pct.Corr.mean, color = PatternType), size = 3, position = position_dodge(0.8)) +   
  geom_errorbar(aes(ymin=Pct.Corr.mean-Pct.Corr.ci,ymax=Pct.Corr.mean+Pct.Corr.ci, color = PatternType), position = position_dodge(0.8), width = .5)  + 
  geom_jitter(position=position_dodge(0.8)) +
  ggtitle("Children: Accuracy by coherence and pattern") +
  xlab("Coherence") +
  theme.custom + # Position legend in bottom right
  ylab("Mean Accuracy (%)") +
  scale_color_viridis(discrete=TRUE) +
  annotate("text", x = 0.6, y = 100, label = "a)", size= 12)
p0
# ggsave("~/R/moco-psychophysics/analysis/pub_image/8_c_acc_speed_coh_new.pdf", p0)
```

### the figure of speed by coherence interaction
```{r}
# df_child$Coh<-factor(df_child$Coh)
df_p2_c_acc_speed_coh <- df_child %>% 
  filter(Group=="linear-radial coh [.15 .3 .45 .6]") %>%
  group_by(SubID, Speed, Coh) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr = N.corr/N.tot)  %>% 
  group_by(Speed, Coh) %>%
  mutate(n=length(Pct.Corr),
            Pct.Corr.mean = 100*mean(Pct.Corr, na.rm=TRUE),
            Pct.Corr.ci = 1.96*100*sd(Pct.Corr, na.rm=TRUE)/sqrt(length(Pct.Corr)))  #computation of the standard error of the mean, ci is 1.96*sem
df_p2_c_acc_speed_coh$Coh<-factor(df_p2_c_acc_speed_coh$Coh, levels=c("0.15","0.3","0.45","0.6"), labels=c("15%","30%","45%","60%"))
p1<-ggplot(df_p2_c_acc_speed_coh, aes(x = Coh, y = Pct.Corr*100, color = Speed, shape=Speed),  alpha = 0.5) +
  geom_point(data = df_p2_c_acc_speed_coh, aes(x = Coh, y = Pct.Corr.mean, color = Speed), size = 3, position = position_dodge(0.8)) +   
  geom_errorbar(aes(ymin=Pct.Corr.mean-Pct.Corr.ci,ymax=Pct.Corr.mean+Pct.Corr.ci, color = Speed), position = position_dodge(0.8), width = .5)  + 
  geom_jitter(position=position_dodge(0.8)) +
  ggtitle("Children: Accuracy by coherence and speed") +
  xlab("Coherence") +
  theme.custom + # Position legend in bottom right
  ylab("Mean Accuracy (%)") +
  scale_color_viridis(discrete=TRUE) +
  annotate("text", x = 0.6, y = 100, label = "b)", size= 12)
#  theme(legend.title=element_blank())
p1
# ggsave("~/R/moco-psychophysics/analysis/pub_image/8_c_acc_speed_coh_new.pdf", p1)
```

### the figure of speed by age interaction
```{r plot-acc-age-speed}
df_p3_c_acc_speed_age <- df_child %>% 
  # filter(Group=="linear-radial coh [.15 .3 .45 .6]") %>%
  group_by(SubID, Speed, Age) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr.mean = 100*N.corr/N.tot)  
p2 <- ggplot(data =  df_p3_c_acc_speed_age, 
       aes(y = Pct.Corr.mean, x = Age, color = Speed, shape = Speed, group = Speed) ) + 
    geom_point() +
    geom_smooth(method="lm") +
    ggtitle("Children: Accuracy by age and speed") +
    xlim(5,9) +
    xlab("Age") +
    ylab("Mean Accuracy (%)") +
    scale_color_viridis(discrete=TRUE) +   
    theme.custom +
    annotate("text", x = 5, y = 100, label = "c)", size= 12)  
p2
# ggsave("~/R/moco-psychophysics/analysis/pub_image/2_c_acc_speed_age_new.pdf", p2)
```

### the figure of the mean accuracy by gender and pattern
```{r}
df_p2_a_acc_gen_pat <- df_child%>% 
  group_by(SubID, PatternType, Gender) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr = N.corr/N.tot)  %>% 
  group_by(PatternType, Gender) %>%
  mutate(n=length(Pct.Corr),
            Pct.Corr.mean = 100*mean(Pct.Corr, na.rm=TRUE),
            Pct.Corr.ci = 1.96*100*sd(Pct.Corr, na.rm=TRUE)/sqrt(length(Pct.Corr)))  #computation of the standard error of the mean, ci is 1.96*sem
df_p2_a_acc_gen_pat$Pattern<-factor(df_p2_a_acc_gen_pat$PatternType, levels=c("linear","radial"), labels=c("Linear","Radial"))
p3<-ggplot(df_p2_a_acc_gen_pat, aes(x = Gender, y = Pct.Corr*100, color = Pattern, shape=Pattern),  alpha = 0.5) +
  geom_point(data = df_p2_a_acc_gen_pat, aes(x = Gender, y = Pct.Corr.mean, color = Pattern), size = 3, position = position_dodge(0.8)) +   
  geom_errorbar(aes(ymin=Pct.Corr.mean-Pct.Corr.ci,ymax=Pct.Corr.mean+Pct.Corr.ci, color = Pattern), position = position_dodge(0.8), width = .5)  + 
  geom_jitter(position=position_dodge(0.8)) +
  ggtitle("Children: Accuracy by sex and pattern") +
  theme.custom + # Position legend in bottom right
  ylab("Mean Accuracy (%)") +
  scale_color_viridis(discrete=TRUE) +
  annotate("text", x = 0.5, y = 100, label = "d)", size= 12)
p3
```

### combine these figures into one figure
```{r}
library(gridExtra)
#p = grid.arrange(ncol = 2, nrow = 2, p0, p1, p2,p3)
p_c = grid.arrange(layout_matrix = rbind(c(1,2),
                                       c(3,4)), p0, p1, p2,p3)
#labels = c("a", "b", "c")
ggsave(plot = p_c, filename = "~/R/moco-psychophysics/analysis/pub_image/child.png", units = "in", height = 12, width = 12, dpi = 600 )
```

# adult
### the figure of mean accuracy by speed and age 
```{r plot-acc-age-speed}
df_p4_c_acc_speed_age <- df_adult %>% 
  # filter(Group=="linear-radial coh [.15 .3 .45 .6]") %>%
  group_by(SubID, Speed, Age) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr.mean = 100*N.corr/N.tot)  
p3 <- ggplot(data =  df_p4_c_acc_speed_age, 
       aes(y = Pct.Corr.mean, x = Age, color = Speed, shape = Speed, group = Speed) ) + 
    geom_point() +
    geom_smooth(method="lm") +
    ggtitle("Adults: Percent correct by coherence and pattern") +
  #  xlim(18,24) +
    xlab("Age") +
    ylab("Mean Accuracy (%)") +
    scale_color_viridis(discrete=TRUE) +   
    theme.custom 
p3
# ggsave("~/R/moco-psychophysics/analysis/pub_image/3_a_acc_speed_age_new.pdf", p3)
```

### the figure of pattern by coherence interaction
```{r}
df_p2_a_acc_pat_coh <- df_adult%>% 
  group_by(SubID, PatternType, Coh) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr = N.corr/N.tot)  %>% 
  group_by(PatternType, Coh) %>%
  mutate(n=length(Pct.Corr),
            Pct.Corr.mean = 100*mean(Pct.Corr, na.rm=TRUE),
            Pct.Corr.ci = 1.96*100*sd(Pct.Corr, na.rm=TRUE)/sqrt(length(Pct.Corr)))  #computation of the standard error of the mean, ci is 1.96*sem
df_p2_a_acc_pat_coh$Coh<-factor(df_p2_a_acc_pat_coh$Coh, levels=c("0.05","0.1","0.15","0.2"), labels=c("5%","10%","15%","20%"))
df_p2_a_acc_pat_coh$Pattern<-factor(df_p2_a_acc_pat_coh$PatternType, levels=c("linear","radial"), labels=c("Linear","Radial"))
p4<-ggplot(df_p2_a_acc_pat_coh, aes(x = Coh, y = Pct.Corr*100, color = Pattern, shape=Pattern),  alpha = 0.1) +
  geom_point(data = df_p2_a_acc_pat_coh, aes(x = Coh, y = Pct.Corr.mean, color = Pattern), size = 3, position = position_dodge(0.8)) +   
  geom_errorbar(aes(ymin=Pct.Corr.mean-Pct.Corr.ci,ymax=Pct.Corr.mean+Pct.Corr.ci, color = Pattern), position = position_dodge(0.8), width = .5)  + 
  geom_jitter(position=position_dodge(0.8)) +
  ggtitle("Adults: Percent correct by coherence and pattern") +
  xlab("Coherence") +
  theme.custom + # Position legend in bottom right
  ylab("Mean Accuracy (%)") +
  scale_color_viridis(discrete=TRUE) +
  annotate("text", x = 0.6, y = 100, label = "a)", size= 12)
p4
# ggsave("~/R/moco-psychophysics/analysis/pub_image/8_a_acc_pattern_coh_new.pdf", p4)
```
### the figure of speed by sex interaction
```{r}
df_p2_a_acc_gen_speed <- df_adult%>% 
  group_by(SubID, Speed, Gender) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr = N.corr/N.tot)  %>% 
  group_by(Speed, Gender) %>%
  mutate(n=length(Pct.Corr),
            Pct.Corr.mean = 100*mean(Pct.Corr, na.rm=TRUE),
            Pct.Corr.ci = 1.96*100*sd(Pct.Corr, na.rm=TRUE)/sqrt(length(Pct.Corr)))  #computation of the standard error of the mean, ci is 1.96*sem
# df_p2_a_acc_gen_speed$Speed<-factor(df_p2_a_acc_gen_speed$Speed, levels=c("2 deg/s","8 deg/s"), labels=c("2 deg/s","8 deg/s"))
p5<-ggplot(df_p2_a_acc_gen_speed, aes(x = Speed, y = Pct.Corr*100, color = Gender, shape=Gender),  alpha = 0.5) +
  geom_point(data = df_p2_a_acc_gen_speed, aes(x = Speed, y = Pct.Corr.mean, color = Gender), size = 3, position = position_dodge(0.8)) +   
  geom_errorbar(aes(ymin=Pct.Corr.mean-Pct.Corr.ci,ymax=Pct.Corr.mean+Pct.Corr.ci, color = Gender), position = position_dodge(0.8), width = .5)  + 
  geom_jitter(position=position_dodge(0.8)) +
  ggtitle("Adults: Percent correct by sex and speed") +
  theme.custom + # Position legend in bottom right
  ylab("Mean Accuracy (%)") +
  scale_color_viridis(discrete=TRUE)  +
  annotate("text", x = 0.5, y = 90, label = "b)", size= 12)
p5
# ggsave("~/R/moco-psychophysics/analysis/pub_image/9_a_acc_speed_gender_new.pdf", p5)
```
### the figure of pattern by sex interaction
```{r}
df_p2_a_acc_gen_pat <- df_adult%>% 
  group_by(SubID, PatternType, Gender) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr = N.corr/N.tot)  %>% 
  group_by(PatternType, Gender) %>%
  mutate(n=length(Pct.Corr),
            Pct.Corr.mean = 100*mean(Pct.Corr, na.rm=TRUE),
            Pct.Corr.ci = 1.96*100*sd(Pct.Corr, na.rm=TRUE)/sqrt(length(Pct.Corr)))  #computation of the standard error of the mean, ci is 1.96*sem
df_p2_a_acc_gen_pat$Pattern<-factor(df_p2_a_acc_gen_pat$PatternType, levels=c("linear","radial"), labels=c("Linear","Radial"))
p6<-ggplot(df_p2_a_acc_gen_pat, aes(x = Pattern, y = Pct.Corr*100, color = Gender, shape=Gender),  alpha = 0.5) +
  geom_point(data = df_p2_a_acc_gen_pat, aes(x = Pattern, y = Pct.Corr.mean, color = Gender), size = 3, position = position_dodge(0.8)) +   
  geom_errorbar(aes(ymin=Pct.Corr.mean-Pct.Corr.ci,ymax=Pct.Corr.mean+Pct.Corr.ci, color = Gender), position = position_dodge(0.8), width = .5)  + 
  geom_jitter(position=position_dodge(0.8)) +
  ggtitle("Adults: Percent correct by sex and pattern") +
  theme.custom + # Position legend in bottom right
  ylab("Mean Accuracy (%)") +
  scale_color_viridis(discrete=TRUE) +
  annotate("text", x = 0.5, y = 90, label = "c)", size= 12)
p6
# ggsave("~/R/moco-psychophysics/analysis/pub_image/8_a_acc_pattern_gender_new.pdf", p6, height=7,width=7)
```

### combine multiple plots into one 
```{r}
# combine multiple plots into one 
# pdf("~/R/moco-psychophysics/analysis/pub_image/adult.pdf")

#set the create the frames
# layout(matrix(c(1,1,2,3), 2, 2, byrow = TRUE))
# or
# par(mfcol=c(2,2))
#dev.off shuts down the specified (by default the current) graphical device
#here it passes the picture to the file
# dev.off()


library(gridExtra)

#p = grid.arrange(ncol = 2, nrow = 2, p4, p5, p6)
p = grid.arrange(layout_matrix = rbind(c(NA,1,1, NA),
                                       c(2,2,3,3)), p4, p5, p6)
#labels = c("a", "b", "c")
ggsave(plot = p, filename = "~/R/moco-psychophysics/analysis/pub_image/adult1.png", units = "in", height = 12, width = 12, dpi = 600 )
```





# SDT
We conducted a comparison between children and adults at the coherence level of 15% using Signal Detection Theory.

### First, combine these two datasets and calculate the d' and c in child and adult datasets from SDT.
```{r get-SDT}
# library(psycho)
# Let's simulate three participants with different results at a perceptual detection task
df_child2 <- df_child %>%
   dplyr::select(SubID, PatternType, RT, Acc, Speed, Gender, Coh, Response, Age) %>%
   dplyr::filter(Coh==0.15) %>%
   dplyr::filter(Response %in% c("L","R"))
str(df_child2)

df_adult2 <- df_adult %>%
   dplyr::select(SubID, PatternType, RT, Acc, Speed, Gender, Coh, Response,Age) %>%
   dplyr::filter(Coh==0.15)  %>%
   dplyr::filter(Response %in% c("L","R"))
df_adult2$SubID<-factor(df_adult2$SubID)
str(df_adult2)

df2<-rbind(df_child2, df_adult2) 
df.new<- df2 %>%
  mutate(group=c(rep('child',nrow(df_child2)),rep('adult',nrow(df_adult2)))) %>%
  filter(Response != "NA") %>%
  group_by(SubID, group, Coh, PatternType, Speed, Gender) %>%
  summarize(n_hit = sum(Response=="L" & Acc=="TRUE"),
            n_fa  = sum(Response=="L" & Acc=="FALSE"),
            n_miss = sum(Response=="R" & Acc=="FALSE"),
            n_cr = sum(Response=="R" & Acc=="TRUE"))

indices <- neuropsychology::dprime(df.new$n_hit, df.new$n_fa, df.new$n_miss, df.new$n_cr)
df.sdt <- cbind(df.new, indices)
```

### We conduct four-way ANOVA to examine the effect of sex, group, speed and pattern on perceptual sensivitity (d') and post hoc comparison. 
``` {r anova-SDT-d'}
library(afex)
df.sdt$SubID<-as.integer(df.sdt$SubID) 
a_d <- aov_ez(id="SubID", dv = "dprime", df.sdt, between = c("Gender", "group"),within=c("Speed","PatternType") )
summary(a_d)
knitr::kable(nice(a_d))
# calculate power
library(pwr)
pwr.anova.test(k = 2, n = 50, f = 0.17, sig.level = 0.05, power = NULL)  # for pattern
pwr.anova.test(k = 2, n = 29, f = 0.15, sig.level = 0.05, power = NULL)  # for group
pwr.f2.test(u =27, v = 1, f2 = 34.94, sig.level = 0.05, power = NULL) # age effect in children
## chilren only
df.sdt.c<-df.sdt %>% filter(group=="child")
a_d.c <- aov_ez(id="SubID", dv = "dprime", df.sdt.c, between = c("Gender"),within=c("Speed","PatternType") )
summary(a_d.c)
knitr::kable(nice(a_d.c))
em_c<-emmeans(a_d.c, ~Gender*PatternType)
pairs(em_c)
em_c1<-emmeans(a_d.c, ~Gender*Speed)
pairs(em_c1)
## adults only
df.sdt.a<-df.sdt %>% filter(group=="adult")
a_d.a <- aov_ez(id="SubID", dv = "dprime", df.sdt.a, between = c("Gender"),within=c("Speed","PatternType") )
summary(a_d.a)
knitr::kable(nice(a_d.a))
em_a<-emmeans(a_d.a, ~Gender*PatternType)
pairs(em_a)
em_a1<-emmeans(a_d.a, ~Gender*Speed)
pairs(em_a1)

# What about the estimated marginal means of the design?
library(emmeans)
emmeans(a_d, ~Gender* group * Speed*PatternType)
# What about the ‘main effects?
em1<-emmeans(a_d, ~Gender)
em2<-emmeans(a_d, ~group)
em3<-emmeans(a_d, ~Speed)
em4<-emmeans(a_d, ~PatternType)
em5<-emmeans(a_d, ~Speed*group)
em6<-emmeans(a_d, ~PatternType*group)
em7<-emmeans(a_d, ~Gender*PatternType)
em8<-emmeans(a_d, ~Gender*PatternType*group)
# And pairwise difference among levels of inference validity?
em1
pairs(em1)
df.sdt %>%
   dplyr::group_by(group) %>%
   summarize(mean=mean(dprime))
```

### create the plot for d' in two conditions of pattern and speed.
``` {r anova-plot}
# Plotting results of aov_ez
emmip(a_d, group ~ PatternType|Speed, CIs = TRUE)
```